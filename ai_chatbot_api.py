"""
Flask API ููู AI Agent
ูููุฑ endpoint ููุชูุงุนู ูุน ุงูุดุงุช ุจูุช ุงูุฐูู
"""

from flask import Flask, request, jsonify
from flask_cors import CORS
import os
import json
from openai import OpenAI
import uuid

app = Flask(__name__)
CORS(app)

# ุฅุนุฏุงุฏ OpenAI client
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# ูุงุนุฏุฉ ุงููุนุฑูุฉ
KNOWLEDGE_BASE = {
    "contact": {
        "keywords": ["ุฑูู", "ูุงุชู", "ุชูุงุตู", "ุงุชุตุงู", "ููุจุงูู", "ุฌูุงู", "ุงูููู", "ุจุฑูุฏ", "email", "phone"],
        "info": """ูุนูููุงุช ุงูุชูุงุตู ูุน ุฌุงูุนุฉ ุนูุงู ุงูุนุฑุจูุฉ:
๐ ุงููุงุชู: 0798877440
๐ ุงููููุน ุงูุฅููุชุฑููู: https://www.aau.edu.jo/ar
๐ ุงูุนููุงู: ุดุงุฑุน ุงูุฃุฑุฏูุ ูุจูุณ - ุนูุงูุ ุงูุฃุฑุฏู
โฐ ุฃููุงุช ุงูุนูู: ูู ุงูุฃุญุฏ ุฅูู ุงูุฎููุณ
๐ฑ ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู: Facebook, LinkedIn, Twitter, YouTube"""
    },
    "rankings": {
        "keywords": ["ุชุตููู", "ุชุฑุชูุจ", "ูุฑุชุจุฉ", "ุฅูุฌุงุฒุงุช", "ุชููุฒ", "ranking", "achievement"],
        "info": """ุฅูุฌุงุฒุงุช ูุชุตูููุงุช ุฌุงูุนุฉ ุนูุงู ุงูุนุฑุจูุฉ:
๐ ุฏุฎูู ุชุตููู QS ุงูุนุงููู 2026 ูููุฑุฉ ุงูุฃููู
๐ฅ ุงููุฑุชุจุฉ 110 ุนุฑุจูุงู ูู ุชุตููู QS Arab Region 2025
๐ฅ ุงููุฑุชุจุฉ ุงูุณุงุฏุณุฉ ูู ุชุตููู ุงูุชุงููุฒ ููุฌุงูุนุงุช ุงูุนุฑุจูุฉ
๐ฅ ุงููุฑุชุจุฉ ุงูุฑุงุจุนุฉ ุฃุฑุฏููุงู ูู ุชุตููู ุงูุชุงููุฒ ููุชุฃุซูุฑ 2025
๐ฅ ุงููุฑุชุจุฉ ุงูุฃููู ุนูู ุงูุฌุงูุนุงุช ุงูุฎุงุตุฉ ูู ุชุตููู ููุจูููุชุฑูุณ 2025
๐ฅ ุงููุฑุชุจุฉ ุงูุฃููู ุนูู ุงูุฌุงูุนุงุช ุงูุฎุงุตุฉ ูุงูุซุงููุฉ ุฃุฑุฏููุงู ูู ุชุตููู ุณููุงุฌู 2025
๐ฅ ุงููุฑุชุจุฉ ุงูุณุงุฏุณุฉ ูุญููุงู ูุถูู ุฃูู 388 ุฌุงูุนุฉ ุนุงูููุงู ูู ุชุตููู Green Metric 2024"""
    },
    "accreditations": {
        "keywords": ["ุงุนุชูุงุฏ", "ุดูุงุฏุฉ", "ุฌูุฏุฉ", "ูุนุชูุฏ", "accreditation", "quality"],
        "info": """ุงูุงุนุชูุงุฏุงุช ุงูุฏูููุฉ ูุฌุงูุนุฉ ุนูุงู ุงูุนุฑุจูุฉ:
โ EUR-ACE: ุงุนุชูุงุฏ ุฏููู ูููุฏุณุฉ ุงูุจุฑูุฌูุงุช (4 ุณููุงุช)
โ AABI: ุงูุฃููู ุนุฑุจูุงู ูุงูุณุงุฏุณ ุนุงูููุงู ูู ุงุนุชูุงุฏ ุงูุทูุฑุงู ุงูุฏููู
โ AACSB: ุงุนุชูุงุฏ ุฃูุฑููู ููููุฉ ุงูุฃุนูุงู (ูุฌุฏุฏ)
โ ACPE: ุงุนุชูุงุฏ ุฃูุฑููู ููููุฉ ุงูุตูุฏูุฉ
โ IAA: ููุงููุฉ ุฃูููุฉ ูุงุนุชูุงุฏ ูููุฉ ุงูุดุฑูุนุฉ
โ EASA: ุงุนุชูุงุฏ ููุงูุฉ ุณูุงูุฉ ุงูุทูุฑุงู ุงูุฃูุฑูุจูุฉ
โ ISO: ุดูุงุฏุฉ ุงูุฃูุฒู (2020-2027)"""
    },
    "majors": {
        "keywords": ["ุชุฎุตุต", "ูููุฉ", "ุจุฑูุงูุฌ", "ุฏุฑุงุณุฉ", "ุจูุงููุฑููุณ", "ูุงุฌุณุชูุฑ", "major", "faculty", "ููุฏุณุฉ", "ุฃุนูุงู", "ุตูุฏูุฉ"],
        "info": """ุงููููุงุช ูุงูุชุฎุตุตุงุช ูู ุฌุงูุนุฉ ุนูุงู ุงูุนุฑุจูุฉ:
๐ ูููุฉ ุงูููุฏุณุฉ: ููุฏุณุฉ ุงูุจุฑูุฌูุงุช (ูุนุชูุฏุฉ EUR-ACE)ุ ููุฏุณุฉ ุงูุทูุฑุงู (ูุนุชูุฏุฉ AABI ู EASA)
๐ผ ูููุฉ ุงูุฃุนูุงู: ูุนุชูุฏุฉ ุฃูุฑูููุงู AACSB - ุฅุฏุงุฑุฉุ ูุญุงุณุจุฉุ ุชุณูููุ ูุงููุฉ
๐ ูููุฉ ุงูุตูุฏูุฉ: ูุนุชูุฏุฉ ุฃูุฑูููุงู ACPE
๐ ูููุฉ ุงูุดุฑูุนุฉ: ุงุนุชูุงุฏ ุฏููู IAA
โ๏ธ ูููุฉ ุงูุญููู
๐จโ๐ซ ูููุฉ ุงูุนููู ุงูุชุฑุจููุฉ ูุงูููุณูุฉ
๐ป ูููุฉ ุชูููููุฌูุง ุงููุนูููุงุช
๐ ูููุฉ ุงูุขุฏุงุจ ูุงูุนููู
โ๏ธ ูููุฉ ุนููู ุงูุทูุฑุงู
๐ฅ ูููุฉ ุงูุนููู ุงูุทุจูุฉ ุงูุชุทุจูููุฉ
๐ง ุงููููุฉ ุงูุชูููุฉ"""
    },
    "admission": {
        "keywords": ["ูุจูู", "ุชุณุฌูู", "ุงูุชุญุงู", "ุทุงูุจ", "ุดุฑูุท", "admission", "registration"],
        "info": """ุงููุจูู ูุงูุชุณุฌูู ูู ุฌุงูุนุฉ ุนูุงู ุงูุนุฑุจูุฉ:
๐ ูุชุญ ุจุงุจ ุงููุจูู ูุงูุชุณุฌูู ูููุตู ุงูุฏุฑุงุณู 2026-2025
๐ ููุงุณุชูุณุงุฑ ูุงูุชุณุฌูู: 0798877440
๐ ุงููููุน ุงูุฅููุชุฑููู: https://www.aau.edu.jo/ar
๐ฅ ูุชุงุญ ููุทูุงุจ ุงูุฃุฑุฏูููู ูุบูุฑ ุงูุฃุฑุฏูููู
๐ ูููู ุงูุชูุงุตู ูุน ูุณู ุงููุจูู ูุงูุชุณุฌูู ููุญุตูู ุนูู ูุนูููุงุช ุชูุตูููุฉ ุนู ุงูุดุฑูุท ูุงูุฃูุฑุงู ุงููุทููุจุฉ"""
    },
    "discounts": {
        "keywords": ["ุฎุตู", "ููุญุฉ", "ุซุงูููุฉ", "ูุนุฏู", "ุถูุงู", "ูุชูุงุนุฏ", "discount", "scholarship"],
        "info": """ุงูุฎุตููุงุช ุงููุชุงุญุฉ ูู ุฌุงูุนุฉ ุนูุงู ุงูุนุฑุจูุฉ:
๐ฐ ุฎุตููุงุช ุญููููุฉ ุฅุถุงููุฉ ููุงูู ูุชุฑุฉ ุงูุฏุฑุงุณุฉ
๐ ุฎุตู ูุนุฏู ุงูุซุงูููุฉ ุงูุนุงูุฉ: ูุตู ุฅูู 90% ุญุณุจ ุงููุนุฏู
๐ด ุฎุตู ูุชูุงุนุฏู ุงูุถูุงู ุงูุงุฌุชูุงุนู
๐ณ ููุงูุฐ ุงูุญููู ุงููุงููุฉ ููุทูุงุจ
๐ ููุงุณุชูุณุงุฑ: 0798877440"""
    },
    "fees": {
        "keywords": ["ุฑุณูู", "ุงูุณุงุท", "ุฏูุน", "ุชูููุฉ", "ุณุนุฑ", "ุณุงุนุฉ", "fees", "tuition"],
        "info": """ุฑุณูู ุงูุฏุฑุงุณุฉ ูู ุฌุงูุนุฉ ุนูุงู ุงูุนุฑุจูุฉ:
๐ต ุฌุฏูู ุฑุณูู ุงูุณุงุนุงุช ุงูุฏุฑุงุณูุฉ ููุตู ูุชููุฑ ุนูู ุงููููุน
๐ณ ููุงูุฐ ุงูุญููู ุงููุงููุฉ ููุทูุงุจ
๐ ุฎุตููุงุช ุชุตู ุฅูู 90% ุญุณุจ ูุนุฏู ุงูุซุงูููุฉ
๐ ููุงุณุชูุณุงุฑ ุนู ุงูุฑุณูู: 0798877440
๐ ุงููููุน: https://www.aau.edu.jo/ar"""
    }
}

def search_aau_knowledge(query):
    """ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ"""
    query_lower = query.lower()
    results = []
    
    for category, data in KNOWLEDGE_BASE.items():
        for keyword in data["keywords"]:
            if keyword in query_lower:
                results.append(data["info"])
                break
    
    if results:
        return "\n\n".join(results)
    
    return """ูู ุฃุฌุฏ ูุนูููุงุช ูุญุฏุฏุฉ ุนู ุณุคุงูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุญุงููุฉ.
ููููู ุงูุชูุงุตู ูุจุงุดุฑุฉ ูุน ุฌุงูุนุฉ ุนูุงู ุงูุนุฑุจูุฉ:
๐ ุงููุงุชู: 0798877440
๐ ุงููููุน: https://www.aau.edu.jo/ar"""

# ุชุนุฑูู ุงูุฃุฏุงุฉ
tools = [
    {
        "type": "function",
        "function": {
            "name": "search_aau_knowledge",
            "description": "ุงูุจุญุซ ูู ูุงุนุฏุฉ ูุนุฑูุฉ ุฌุงูุนุฉ ุนูุงู ุงูุนุฑุจูุฉ",
            "parameters": {
                "type": "object",
                "properties": {
                    "query": {
                        "type": "string",
                        "description": "ุณุคุงู ุงููุณุชุฎุฏู"
                    }
                },
                "required": ["query"]
            }
        }
    }
]

SYSTEM_MESSAGE = """ุฃูุช Tec ๐คุ ูุณุงุนุฏ ุฐูู ูุชุฎุตุต ูู ุฌุงูุนุฉ ุนูุงู ุงูุนุฑุจูุฉ.

ูููุชู:
1. ููู ุฃุณุฆูุฉ ุงููุณุชุฎุฏููู ุจุฏูุฉ
2. ุงุณุชุฎุฏุงู ุฃุฏุงุฉ ุงูุจุญุซ ููุญุตูู ุนูู ูุนูููุงุช ุฏูููุฉ
3. ุชูุฏูู ุฅุฌุงุจุงุช ูุงุถุญุฉ ููููุฏุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ
4. ุฅุฐุง ูู ุชุฌุฏ ุงููุนูููุฉุ ูุฌู ุงููุณุชุฎุฏู ููุงุชุตุงู ุจุงูุฌุงูุนุฉ

ุฃุณููุจู:
- ูุฏูุฏ ููุญุชุฑู
- ูุงุถุญ ููุจุงุดุฑ
- ุงุณุชุฎุฏู ุงูุฅูููุฌู ุจุดูู ููุงุณุจ
- ูุฏู ูุนูููุงุช ููุธูุฉ ูุณููุฉ ุงููุฑุงุกุฉ"""

# ุชุฎุฒูู ุงููุญุงุฏุซุงุช
conversations = {}

@app.route('/api/chat', methods=['POST'])
def chat():
    """API endpoint ููุชูุงุนู ูุน ุงูุดุงุช ุจูุช"""
    try:
        data = request.json
        message = data.get('message', '')
        session_id = data.get('session_id', str(uuid.uuid4()))
        
        if not message:
            return jsonify({'error': 'Message is required'}), 400
        
        # ุฅูุดุงุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
        if session_id not in conversations:
            conversations[session_id] = [
                {"role": "system", "content": SYSTEM_MESSAGE}
            ]
        
        # ุฅุถุงูุฉ ุฑุณุงูุฉ ุงููุณุชุฎุฏู
        conversations[session_id].append({"role": "user", "content": message})
        
        # ุงุณุชุฏุนุงุก OpenAI
        response = client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=conversations[session_id],
            tools=tools,
            tool_choice="auto"
        )
        
        response_message = response.choices[0].message
        tool_calls = response_message.tool_calls
        
        # ุฅุฐุง ุทูุจ ุงููููู ุงุณุชุฎุฏุงู ุฃุฏุงุฉ
        if tool_calls:
            conversations[session_id].append(response_message)
            
            for tool_call in tool_calls:
                function_name = tool_call.function.name
                function_args = json.loads(tool_call.function.arguments)
                
                if function_name == "search_aau_knowledge":
                    function_response = search_aau_knowledge(function_args.get("query"))
                    
                    conversations[session_id].append({
                        "tool_call_id": tool_call.id,
                        "role": "tool",
                        "name": function_name,
                        "content": function_response
                    })
            
            # ุงุณุชุฏุนุงุก ุซุงูู ููุญุตูู ุนูู ุงูุฅุฌุงุจุฉ ุงูููุงุฆูุฉ
            second_response = client.chat.completions.create(
                model="gpt-4.1-mini",
                messages=conversations[session_id]
            )
            
            final_message = second_response.choices[0].message.content
            conversations[session_id].append({"role": "assistant", "content": final_message})
            
            return jsonify({
                'response': final_message,
                'session_id': session_id
            })
        
        else:
            # ุฅุฌุงุจุฉ ูุจุงุดุฑุฉ ุจุฏูู ุงุณุชุฎุฏุงู ุฃุฏูุงุช
            final_message = response_message.content
            conversations[session_id].append({"role": "assistant", "content": final_message})
            
            return jsonify({
                'response': final_message,
                'session_id': session_id
            })
    
    except Exception as e:
        return jsonify({
            'error': str(e),
            'response': "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ. ููููู ุงูุชูุงุตู ูุน ุงูุฌุงูุนุฉ ุนูู: 0798877440"
        }), 500

@app.route('/api/health', methods=['GET'])
def health():
    """Health check endpoint"""
    return jsonify({'status': 'ok', 'message': 'Tec AI Agent is running'})

if __name__ == '__main__':
    port = int(os.getenv('PORT', 5001))
    app.run(host='0.0.0.0', port=port, debug=True)

